#!/bin/bash
# Secrets Manager - Simple age-based secret retrieval
# Usage:
#   secrets KEY                    - Get single secret value
#   secrets -l, --list            - List all secret keys
#   secrets -e, --export          - Export all secrets as env vars
#   secrets -s, --source          - Source all secrets (use: eval $(secrets -s))
#   secrets --encrypt FILE        - Encrypt a secrets file
#   secrets --decrypt             - Decrypt and display all secrets

SECRETS_DIR="${SECRETS_DIR:-$HOME/.ssh/tailscale-fleet/secrets}"
SECRETS_FILE="${SECRETS_DIR}/credentials.env"
ENCRYPTED_FILE="${SECRETS_FILE}.age"
AGE_KEY="$HOME/.age/key.txt"

# Check if age key exists
if [[ ! -f "$AGE_KEY" ]]; then
    echo "Error: Age key not found at $AGE_KEY" >&2
    echo "Generate one with: age-keygen -o ~/.age/key.txt" >&2
    exit 1
fi

# Decrypt secrets to temporary variable
decrypt_secrets() {
    if [[ ! -f "$ENCRYPTED_FILE" ]]; then
        echo "Error: Encrypted secrets file not found at $ENCRYPTED_FILE" >&2
        echo "Encrypt your secrets with: secrets --encrypt $SECRETS_FILE" >&2
        return 1
    fi
    age -d -i "$AGE_KEY" "$ENCRYPTED_FILE" 2>/dev/null
}

# Get single secret value
get_secret() {
    local key="$1"
    decrypt_secrets | grep "^${key}=" | cut -d= -f2- | head -1
}

# List all secret keys
list_secrets() {
    decrypt_secrets | grep -v '^#' | grep -v '^$' | cut -d= -f1 | sort
}

# Export all secrets as environment variables
export_secrets() {
    decrypt_secrets | grep -v '^#' | grep -v '^$'
}

# Encrypt a file
encrypt_file() {
    local input_file="$1"
    if [[ ! -f "$input_file" ]]; then
        echo "Error: File not found: $input_file" >&2
        exit 1
    fi

    local public_key=$(age-keygen -y "$AGE_KEY")
    age -e -r "$public_key" "$input_file" > "${input_file}.age"
    chmod 600 "${input_file}.age"
    echo "Encrypted: ${input_file} -> ${input_file}.age"
}

# Main command handler
case "${1:-}" in
    -l|--list)
        list_secrets
        ;;
    -e|--export)
        export_secrets
        ;;
    -s|--source)
        # Output format suitable for eval
        export_secrets | while IFS= read -r line; do
            echo "export $line"
        done
        ;;
    --decrypt)
        decrypt_secrets
        ;;
    --encrypt)
        if [[ -z "$2" ]]; then
            echo "Usage: secrets --encrypt FILE" >&2
            exit 1
        fi
        encrypt_file "$2"
        ;;
    -h|--help)
        echo "Secrets Manager - Simple age-based secret retrieval"
        echo ""
        echo "Usage:"
        echo "  secrets KEY                    - Get value for KEY"
        echo "  secrets -l, --list            - List all secret keys"
        echo "  secrets -e, --export          - Export all secrets (KEY=value format)"
        echo "  secrets -s, --source          - Output for sourcing (eval \$(secrets -s))"
        echo "  secrets --decrypt             - Decrypt and display all secrets"
        echo "  secrets --encrypt FILE        - Encrypt a secrets file"
        echo "  secrets -h, --help            - Show this help"
        echo ""
        echo "Examples:"
        echo "  secrets PLEX_TOKEN            - Get PLEX_TOKEN value"
        echo "  PLEX_TOKEN=\$(secrets PLEX_TOKEN)"
        echo "  eval \$(secrets -s)            - Load all secrets as env vars"
        echo ""
        echo "Files:"
        echo "  Encrypted: $ENCRYPTED_FILE"
        echo "  Age key:   $AGE_KEY"
        ;;
    "")
        echo "Usage: secrets KEY | -l | -e | -s | --decrypt | --encrypt FILE | -h" >&2
        exit 1
        ;;
    *)
        # Get single secret
        value=$(get_secret "$1")
        if [[ -z "$value" ]]; then
            echo "Error: Secret '$1' not found" >&2
            exit 1
        fi
        echo "$value"
        ;;
esac
